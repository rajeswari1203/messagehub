# message-hub-console-sample
This Java console application demonstrates how to connect to [IBM Message Hub](https://console.ng.bluemix.net/docs/services/MessageHub/index.html), send and receive messages using the [Kafka](https://kafka.apache.org) Java API. It also shows how to create and list topics using the Message Hub Admin REST API.

It can be run locally on your machine or deployed into [IBM Bluemix](https://console.ng.bluemix.net/).

__Important Note__: This sample creates on your behalf a topic named `message-hub-console-sample-topic` with one partition - this will incur a fee if the topic does not already exist on your account.

## Global Prerequisites
To build and run the sample, you must have the following installed:
* [git](https://git-scm.com/)
* [Gradle](https://gradle.org/)
* Java 7+
* [Message Hub Service Instance](https://console.ng.bluemix.net/catalog/services/message-hub/) provisioned in [IBM Bluemix](https://console.ng.bluemix.net/)

## Prerequisites (Bluemix)
* [Cloud Foundry Command Line Interface](https://github.com/cloudfoundry/cli/releases) installed
* Open the `manifest.yml` file and rename the `"Message Hub-CHANGEME"` entry to that of your own
Message Hub Service Instance name.

## Running the Build Script
Run the following commands on your local machine, after the prerequisites for your environment have been completed:
```shell
gradle clean && gradle build
 ```

## Running the Sample (Local)
Once built, to run the sample, execute the following command:
```shell
java -jar build/libs/message-hub-console-sample-2.0.jar <kafka_brokers_sasl> <kafka_admin_url> <api_key>
```

To find the values for `<kafka_brokers_sasl>`, `<kafka_admin_url>` and `<api_key>`, access your Message Hub instance in Bluemix, go to the `Service Credentials` tab and select the `Credentials` you want to use.

__Note__: `<kafka_brokers_sasl>` must be a single string enclosed in quotes. For example: `"host1:port1,host2:port2"`. We recommend using all the Kafka hosts listed in the `Credentials` you selected.

Alternatively, you can run only the producer or only the consumer by respectively adding `-producer` or `-consumer`  to the command above.

The sample will run indefinitely until interrupted. To stop the process, use `Ctrl+C`, for example.

## Running the Sample (Bluemix)
Ensure that the previous `gradle build` command has produced a zip file artifact under `build/distributions`.

Connect to Bluemix with the Cloud Foundry Command Line Interface, then run the following command in
the same directory as the `manifest.yml` file:
```shell
cf push
```

__Note:__ The Bluemix distribution will automatically update the required files for you at runtime,
using the `VCAP_SERVICES` information provided by Bluemix.

## Sample Output
Below is a snippet of the output generated by the sample:

```
[2016-11-22 12:29:16,284] INFO Running in local mode. (com.messagehub.samples.MessageHubConsoleSample)
[2016-11-22 12:29:16,285] INFO Updating JAAS configuration (com.messagehub.samples.MessageHubConsoleSample)
[2016-11-22 12:29:16,296] INFO Resource directory: /Users/ecomar/devel/ws-mariposa/message-hub-samples/java/message-hub-console-sample/resources (com.messagehub.samples.MessageHubConsoleSample)
[2016-11-22 12:29:16,296] INFO Kafka Endpoints: kafka01-prod01.messagehub.services.us-south.bluemix.net:9093,kafka02-prod01.messagehub.services.us-south.bluemix.net:9093,kafka03-prod01.messagehub.services.us-south.bluemix.net:9093,kafka04-prod01.messagehub.services.us-south.bluemix.net:9093,kafka05-prod01.messagehub.services.us-south.bluemix.net:9093 (com.messagehub.samples.MessageHubConsoleSample)
[2016-11-22 12:29:16,297] INFO Rest API Endpoint: https://kafka-rest-prod01.messagehub.services.us-south.bluemix.net:443 (com.messagehub.samples.MessageHubConsoleSample)
[2016-11-22 12:29:16,297] INFO Creating the topic message-hub-console-sample-topic (com.messagehub.samples.MessageHubConsoleSample)
 (com.messagehub.samples.MessageHubConsoleSample)
[2016-11-22 12:29:17,776] INFO Listing Topics: [{"name":"message-hub-console-sample-topic","partitions":1,"retentionMs":"86400000","markedForDeletion":false},{"name":"testtopic","partitions":1,"retentionMs":"86400000","markedForDeletion":false},{"name":"testtopic2","partitions":2,"retentionMs":"86400000","markedForDeletion":false}] (com.messagehub.samples.MessageHubConsoleSample)
[2016-11-22 12:29:17,911] INFO MessageHubConsoleSample will run until interrupted. (com.messagehub.samples.MessageHubConsoleSample)
[2016-11-22 12:29:17,911] INFO class com.messagehub.samples.ProducerRunnable is starting. (com.messagehub.samples.ProducerRunnable)
[2016-11-22 12:29:17,911] INFO class com.messagehub.samples.ConsumerRunnable is starting. (com.messagehub.samples.ConsumerRunnable)
[2016-11-22 12:29:19,685] INFO Message produced, offset: 0 (com.messagehub.samples.ProducerRunnable)
[2016-11-22 12:29:20,941] INFO Message produced, offset: 1 (com.messagehub.samples.ProducerRunnable)
[2016-11-22 12:29:22,106] INFO Message produced, offset: 2 (com.messagehub.samples.ProducerRunnable)
[2016-11-22 12:29:23,255] INFO Message produced, offset: 3 (com.messagehub.samples.ProducerRunnable)
[2016-11-22 12:29:23,371] INFO Message Consumed: ConsumerRecord(topic = message-hub-console-sample-topic, partition = 0, offset = 3, CreateTime = 1479817763110, checksum = 2348322079, serialized key size = 3, serialized value size = 25, key = key, value = This is a test message #3) (com.messagehub.samples.ConsumerRunnable)
[2016-11-22 12:29:24,511] INFO Message Consumed: ConsumerRecord(topic = message-hub-console-sample-topic, partition = 0, offset = 4, CreateTime = 1479817764257, checksum = 3709756738, serialized key size = 3, serialized value size = 25, key = key, value = This is a test message #4) (com.messagehub.samples.ConsumerRunnable)
```
